<template name="devLayout">
  <div class="container listing">
    <div class="row">
      <div id="alerts">
      </div>
    </div>
    {{yield}}
  </div>
</template>

<template name="devMain">
  {{> devNav}}
  {{> devBody}}
</template>

<template name="devBody">
  {{#if SEql 'searching' 'after'}}
    {{> findingsMap}}
    {{> subscribe}}
    {{> listOfGames}}
  {{else}}
    {{> listOfGames}}
  {{/if}}
</template>

<template name="devNav">
  {{> optionsMain}}
  {{> optionsExtended}}
</template>

<template name="optionsMain">
  <div class="options-main row">
    {{#if SEql 'searching' 'not'}}
      {{> settingsCog}}
      {{> startSearch}}
      {{> addGameLink}}
    {{else}}
      {{> searchBacktrack}}
      {{> searchInput}}
    {{/if}}
  </div>
</template>

<template name="searchBacktrack">
  {{#if SEql 'searching' 'during'}}
    {{> exitSearch}}
  {{else}}
    {{> back}}
  {{/if}}
</template>

<template name="optionsExtended">
  <div class="options-extended row">
    <div class="content-all">
      {{{alerts 'top'}}}
      {{#if SGet 'viewing-settings'}}
        {{> settings}}
      {{/if}}
      {{#if SEql 'searching' 'during'}}
        {{> selectGameTypes}}
        {{> runSearch}}
      {{/if}}
    </div>
  </div>
</template>

<template name="listOfGames">
  <ul class="list-of-games list-group">
    {{#if currentUser}}
      {{#each userOrganizingUpcoming}}
        {{> listedGame}}
      {{/each}}
      {{#each userPlayingUpcoming}}
        {{> listedGame}}
      {{/each}}
    {{/if}}

    {{#each nonuserUpcoming}}
      {{> listedGame}}
    {{/each}}

    {{#if SGet 'gamesReady'}}
      {{#if noneUpcoming}}
        <li class="list-group-item">
          There are no upcoming games within {{maxDistance}}. :(
        </li>
      {{/if}}
    {{else}}
      <li class="list-group-item">
        {{> spinner}}
      </li>
    {{/if}}

    {{#each pastGames}}
      {{> listedGame}}
    {{/each}}

    {{> loadMoreGames}}
  </ul>
</template>

<template name="loadMoreGames">
  {{#unless noMoreGames}}
    <div class="load-more-games">
      <a>Load more</a>
    </div>
  {{/unless}}
</template>

<template name="listedGame">
  <li class="list-group-item listed-game {{#if past startsAt}}past{{/if}}">
    {{> gameTypeIndicator}}
    {{> listedGameSummary}}
    {{#unless past startsAt}}
      {{#if userInGame}}
        {{> addFriendsLink}}
      {{else}}
        {{> joinGameLink}}
      {{/if}}
      {{{alerts}}}
      {{> addPlayers}}
    {{/unless}}
  </li>
</template>

<template name="gameTypeIndicator">
  <div class="game-type-indicator">
    <span class="ppicon-{{type}}"></span>
  </div>
</template>

<template name="listedGameSummary">
  <div class="game-summary">
    {{> gameWhen}}
    {{> whoIsPlaying}}
    <div class="place">
      <div class="place-name">
        {{placeName}}
        <!-- <span class="place-distance">({{placeDistance}})</span> -->
      </div>
    </div>
  </div>
</template>

<template name="soloGameSummary">
  <div class="game-summary">
    <strong>{{type}}</strong>
    {{> gameWhen}}
    {{> whoIsPlaying}}
    <div class="place">
      <div class="place-name">
        {{placeName}}
      </div>
      <div class-"place-location">{{placeLocation}}</div>
    </div>
    <div class="organizer-info">
      Added by {{creator.name}}
    </div>
  </div>
</template>

<template name="gameWhen">
  <div class="game-when">
    {{#if past startsAt}}
      Ended {{fromNow}}
    {{else}}
      {{displayTime}}
    {{/if}}
  </div>
</template>

<template name="whoIsPlaying">
  <div class="who-is-playing">
    {{#if organizing}}
      <strong class="text-{{#if past startsAt}}muted{{else}}info{{/if}}">
        {{participle startsAt past='Organized' present='Organizing'}}
      </strong>
        + {{numNeeded}} needed
    {{else}}
      {{#if playing}}
        <strong class="text-{{#if past startsAt}}muted{{else}}success{{/if}}">
          {{participle startsAt past='Played' present='Playing'}}
        </strong>
        + {{numNeeded}} needed
      {{else}}
        {{players.length}}
        {{participle startsAt past='played' present='playing'}}
        ({{numNeeded}} needed)
      {{/if}}
    {{/if}}
  </div>
</template>

<template name="joinGameLink">
  <div class="join-game-link">
    <a class="{{#if SEql 'unauth-join' _id}}text-muted{{/if}}">Join</a>
  </div>
</template>

<template name="addFriendsLink">
  <div class="add-friends-link">
    <a><span class="ppicon-add-friend"></span></a>
  </div>
</template>

<template name="addInfoOrSignIn">
  <h5 class="add-info-or-sign-in form-heading">
    {{#unless SGet 'sign-in'}}
      Add your info or <a class="sign-in">sign in</a>
    {{else}}
      Sign in or <a class="add-info">add your info</a>
    {{/unless}}
    to {{action}}.
  </h5>
  <div class="tight form-group">
    <input type="email" class="form-control email"
           placeholder="Your email" value="{{email}}" required autofocus>
    {{#unless SGet 'sign-in'}}
      <input type="text" class="form-control full-name"
             placeholder="Your full name" required>
    {{else}}
      <input type="password" class="form-control password"
             placeholder="Your password" required>
    {{/unless}}
  </div>
</template>

<template name="addPlayers">
  <div class="add-players">
    {{#if SEql 'unauth-join' _id}}
      {{> addSelfAndFriends}}
    {{/if}}
    <!-- 'unauth-join' and 'add-friends' should never both be non-null
         because 'add-friends' is for authenticated users. -->
    {{#if SEql 'add-friends' _id}}
      {{> addFriends}}
    {{/if}}
  </div>
</template>

<template name="addSelfAndFriends">
  <div class="add-self-and-friends well">
    <button type="button" class="close" aria-hidden="true">&times;</button>
    <form class="add-self-and-friends" role="form">
      {{{addInfoOrSignInTo 'join'}}}
      {{> unauthAddFriends}}
      {{{alerts}}}
      <button type="submit" class="btn join-game">Join Game</button>
    </form>
  </div>
</template>

<template name="addFriends">
  <div class="add-friends well">
    <button type="button" class="close" aria-hidden="true">&times;</button>
    <form class="add-friends" role="form">
      {{> addFriendsInput}}
      {{{alerts}}}
      <button type="submit" class="btn add-friends">Add friends</button>
    </form>
  </div>
</template>

<template name="unauthAddFriends">
  {{#if SEql 'unauth-add-friends' _id}}
    {{> addFriendsInput}}
  {{else}}
    {{> unauthAddFriendsLink}}
  {{/if}}
</template>

<template name="unauthAddFriendsLink">
  <div class="form-group">
    <p class="form-control-static">
      <a class="unauth-add-friends-link">
        <span class="glyphicon glyphicon-plus-sign"></span>
        Add friend</a>
    </p>
  </div>
</template>

<template name="addFriendsInput">
  {{#each friends}}
    <p class="form-heading">Add friend</p>
    <div class="tight form-group">
      <input type="text" class="form-control friend-name"
             placeholder="Friend's name"
             value="{{name}}" id="{{_id}}"
             required autofocus>
      <input type="email" class="form-control friend-email"
             placeholder="Friend's email (optional)"
             value="{{email}}" id="{{_id}}">
    </div>
  {{/each}}
  <div class="form-group">
    <p class="form-control-static">
      <a class="add-another-friend">
        <span class="glyphicon glyphicon-plus-sign"></span>
        Add friend</a>
    </p>
  </div>
</template>

<template name="settingsCog">
  <div class="settings-cog">
    {{#if SGet 'viewing-settings'}}
      <a><span class="nav-icon ppicon-cog text-muted"></span></a>
    {{else}}
      <a><span class="nav-icon ppicon-cog"></span></a>
    {{/if}}
  </div>
</template>

<template name="startSearch">
  <div class="start-search">
    <a><span class="nav-icon ppicon-search"></span></a>
  </div>
</template>

<template name="addGameLink">
  <div class="add-game-link">
    {{#link route="devAddGame"}}Add game{{/link}}
  </div>
</template>

<template name="searchInput">
  <div class="search-input">
    <div class="input-group">
      <span class="input-group-btn">
        {{> getCurrentLocation}}
      </span>
      <input class="form-control" type="search" placeholder="Enter Location"
             autofocus required>
    </div>
  </div>
</template>

<template name="getCurrentLocation">
  <button class="btn btn-default get-current-location" type="button">
    {{#unless SGet 'get-user-location'}}
      <i class="fa fa-location-arrow"></i>
    {{/unless}}
    {{#if SEql 'get-user-location' 'pending'}}
      <i class="fa fa-refresh fa-spin"></i>
    {{/if}}
    {{#if SEql 'get-user-location' 'success'}}
      <i class="fa fa-check-circle"></i>
    {{/if}}
    {{#if SEql 'get-user-location' 'failure'}}
      <i class="fa fa-exclamation"></i>
    {{/if}}
  </button>
</template>

<template name="exitSearch">
  <div class="exit-search">
    <a><span class="nav-icon ppicon-cancel"></span></a>
  </div>
</template>

<template name="selectGameTypes">
  <div class="select-game-types">
    {{#each options}}
      <div><label>
          <input type="checkbox" value="{{value}}" checked>
          {{value}}
      </label></div>
    {{/each}}
  </div>
</template>

<template name="runSearch">
  <div class="run-search">
    <button type="button"
            class="btn find-games">Find games</button>
  </div>
</template>

<template name="back">
  <div class="back">
    <a><span class="nav-icon ppicon-left-open"></span></a>
  </div>
</template>

<template name="findingsMap">
  <div class="findings-map">
  {{#constant}}
    <div class="findings-map-wrapper">
      <div class="findings-map-canvas map-canvas"></div>
    </div>
  {{/constant}}
  </div>
</template>

<template name="subscribe">
  <div class="subscribe">
    <div class="subscribe-detail">
      {{detail}}
    </div>
    {{#if SEql 'unauth-subscribe' true}}
      {{> authenticateAndSubscribe}}
    {{else}}
      {{{alerts}}}
      {{#unless subscribed}}
        {{> subscribeButton}}
      {{/unless}}
    {{/if}}
  </div>
</template>

<template name="authenticateAndSubscribe">
  <div class="authenticate-and-subscribe well">
    <button type="button" class="close" aria-hidden="true">&times;</button>
    <form class="authenticate-and-subscribe" role="form">
      {{{addInfoOrSignInTo 'subscribe'}}}
      {{{alerts}}}

      <!-- Not Template.subscribeButton because we don't want to trigger
           its event handlers-->
      <button type="submit" class="btn subscribe">
        <span class="glyphicon glyphicon-envelope"></span> Subscribe
      </button>
    </form>
  </div>
</template>

<template name="subscribeButton">
  <div class="subscribe-button">
    <button type="button"
            class="btn btn-primary center-block">
      <span class="glyphicon glyphicon-envelope"></span>
      Subscribe</button>
  </div>
</template>

<template name="devDetail">
  {{> devDetailNav}}
  {{> devDetailBody}}
</template>

<template name="devDetailNav">
  <div class="dev-detail-nav row">
    <div class="content-all">
      {{> backToList}}
      {{> gameTypeIndicator}}
      {{> shareGameLink}}
      {{> editGameLink}}
      {{> copyGameLink}}
    </div>
  </div>
</template>

<template name="backToList">
  <div class="back-to-list">
    {{#link route="dev"}}
      <span class="ppicon-left-open"></span>
      Pickups
    {{/link}}
  </div>
</template>

<template name="shareGameLink">
  <div class="share-game-link">
    <a><span class="ppicon-link"></span>
      Share</a>
  </div>
</template>

<template name="copyGameLink">
  <div class="copy-game-link">
    {{#if SEql 'copy-game-link' _id}}
      <span class="ppicon-link"></span>
      <input type="text"
             value="{{baseURL}}{{pathFor 'devDetail'}}"
             autofocus>
      <button type="button" class="close" aria-hidden="true">&times;</button>
    {{/if}}
  </div>
</template>

<template name="editGameLink">
  {{#if isCreator}}
    <div class="edit-game-link">
      <a href="{{pathFor 'devEditGame'}}">Edit</a>
    </div>
  {{/if}}
</template>

<template name="devDetailBody">
  <div class="dev-detail-body row">
    <div class="content-all">
      {{{alerts}}}
      {{> soloGameMap}}
      {{> soloGameSummary}}
      {{#unless past startsAt}}
        {{#if userInGame}} {{> addFriendsLink}} {{/if}}
        {{> addPlayers}}
        {{> joinOrLeave}}
      {{/unless}}
      {{> organizersNote}}
      {{#unless past startsAt}}
        {{> whosPlayingSummary}}
      {{/unless}}
      {{> comments}}
      {{> addComment}}
    </div>
  </div>
</template>

<template name="soloGameMap">
  <div class="solo-game-map">
    {{#constant}}
      <div class="solo-game-map-wrapper">
        <div class="solo-game-map-canvas map-canvas"></div>
      </div>
    {{/constant}}
  </div>
</template>

<template name="joinOrLeave">
  <div class="join-or-leave">
    {{#unless addingPlayers}}
      {{#unless userInGame}}
        <button type="button" class="btn join-game">Join game</button>
      {{else}}
        <button type="button" class="btn leave-game">Leave game</button>
      {{/unless}}
    {{/unless}}
  </div>
</template>

<template name="organizersNote">
  <div class="organizers-note">
    {{#if note}}
    <strong>Organizer's note</strong>
      <div>{{note}}</div>
    {{/if}}
  </div>
</template>

<template name="whosPlayingSummary">
  <div class="whos-playing-summary">
    <strong>{{players.length}} playing</strong>
    <ul>
    {{#each userPlayers}}
      <li>
        {{name}}
        {{#with friends ../players}}
          + {{numFriends}}
        {{/with}}
      </li>
    {{else}}
      <li>Be the first to join and add friends :)</li>
    {{/each}}
    </ul>
  </div>
</template>

<template name="comments">
  <div class="comments">
    <strong>{{numComments}}
      {{pluralize comments 'Comment' 'Comments'}}</strong>
    <ul>
      {{#each comments}}
        <li> {{> gameComment}} </li>
      {{/each}}
    </ul>
  </div>
</template>

<template name="addComment">
  <div class="add-comment">
    {{#if SGet 'unauth-comment'}}
      {{> authenticateAndComment}}
    {{else}}
      <form class="add-comment" role="form">
        {{{alerts 'addComment'}}}
        <div class="form-group">
          <input class="form-control comment"
                 type="text"
                 placeholder="Add comment or question">
        </div>
      </form>
    {{/if}}
  </div>
</template>

<template name="authenticateAndComment">
  <div class="authenticate-and-comment">
    <button type="button" class="close" aria-hidden="true">&times;</button>
    <form class="authenticate-and-comment" role="form">
      {{{addInfoOrSignInTo 'comment'}}}
      <div class="form-group">
        <input class="form-control comment"
               type="text"
               placeholder="Add comment or question"
               value="{{SGet 'unauth-comment'}}">
      </div>
      {{{alerts}}}
      <button type="submit" class="btn add-comment">Add Comment</button>
    </form>
  </div>
</template>

<template name="devEditableGame">
  <div id="{{action}}Game">
    <div class="header">
      <div class="close pull-left">
        {{#link route="dev"}}
          <span class="nav-icon ppicon-cancel"></span>
        {{/link}}
      </div>
      <h3 class="title">{{title}}</h3>
    </div>
    <div class="body">
      <form id="{{action}}GameForm" role="form">
        {{{addInfoOrSignInTo 'add this game'}}}
        <div class="form-group">
          {{{selectType}}}
        </div>
        <div class="form-group">
          {{> devSelectWhen}}
        </div>
        <div class="form-group">
          {{> devSelectLocation}}
        </div>
        <div class="form-group">
          {{> editableGameMap}}
        </div>
        <div class="form-group requested">
          {{{selectPlayersRequested}}}
        </div>
        {{#if atLeastOnePlayer}}
          <div class="form-group gamePlayers">
              <p class="form-control-static">
                {{> whosPlayingEditable}}
              </p>
          </div>
        {{/if}}
        <div class="form-group">
          <label for="gameNote" class="control-label">Details (250 characters max)</label>
          <textarea class="form-control" id="gameNote"
                    placeholder="Does anybody need to bring equipment or a field fee?"
                    maxlength="250">{{note}}</textarea>
        </div>
        <div class="form-group">
          <label for="inviteFriends" class="control-label">Invite friends</label>
          <textarea class="form-control" id="inviteFriends"
                    placeholder="example@gmail.com, another@gmail.com"
                    >{{invitedFriends}}</textarea>
        </div>
        {{#if editingGame}}
          <span class="help-block">
            Only game updates with a changed "Details" field will
            notify players. Tell them what you updated and why.
          </span>
        {{/if}}
        <!-- <p class="form-control-static"> -->
        <!--   Please let players contact you (your email address -->
        <!--   will not be visible to them; we will forward messages -->
        <!--   to you). Your game will not be visible to others until -->
        <!--   you verify your email address (confirmation sent from -->
        <!--   support@pushpickup.com). Thanks! -->
        <!-- </p> -->
        {{#unless editingGame}}
          <div class="form-group">
            <label>
              <input type="checkbox" class="playing" value="playing" checked>
              Join game
            </label>
          </div>
        {{/unless}}
        {{{alerts}}}
        <button for="{{action}}GameForm" type="submit"
                class="btn {{action}}-game">
          {{> submitAndWait}}
        </button>
        {{#if editingGame}}
          <div><a class="text-danger remove">Cancel game</a></div>
        {{/if}}
      </form>
    </div>
  </div>
</template>

<template name="devSelectWhen">
  {{{selectDay}}}
  {{{selectTime}}}
</template>

<template name="submitAndWait">
  {{#spinnerIfWaiting action}}
    {{submit}}
  {{/spinnerIfWaiting}}
</template>

<template name="whosPlayingEditable">
  <div class="whos-playing-editable">
    <strong>{{players.length}} playing</strong>
    <ul>
      {{#each userPlayers}}
        <li>
          <input type="checkbox" class="hidden" id="{{userId}}"
                 value="{{userId}}">
          <label for="{{userId}}">
            {{name}}
            {{#with friends ../players}}
              + {{numFriends}}
            {{/with}}
            <span class="text-danger">remove</span>
          </label>
        </li>
      {{/each}}
    </ul>
  </div>
</template>

<template name="devSelectLocation">
  <div class="select-location">
    <div class="input-group">
      <input class="form-control location" type="text" placeholder="Add Location"
             value="{{location.name}}"
             required>
      <span class="input-group-addon">
        <span class="ppicon-location"></span>
      </span>
    </div>
  </div>
</template>

<template name="editableGameMap">
  {{#if showMap}}
    <div class="editable-game-map">
      <div class="editable-game-map-wrapper">
        <div class="editable-game-map-canvas map-canvas"></div>
      </div>
    </div>
  {{/if}}
</template>

<template name="settings">
  <ul class="settings list-group">
    {{{alerts 'settings'}}}
    {{#if currentUser}}
      <li class="user-info list-group-item">
        <div class="user-full-name">
          {{currentUser.profile.name}}
        </div>
        <div class="user-email-address">
          {{currentUser.emails.0.address}}
        </div>
      </li>
      {{{settingsItem 'subscriptions'}}}
      {{{settingsItem 'change-email-address'}}}
      {{{settingsItem 'change-password'}}}
      {{{settingsItem 'help-and-feedback'}}}
      <li class="sign-out trigger list-group-item">Sign Out</li>
    {{else}}
      {{{settingsItem 'sign-in'}}}
      {{{settingsItem 'sign-up'}}}
      {{#if SGet 'set-password-token'}}
        {{{settingsItem 'set-password'}}}
      {{else}}
        {{{settingsItem 'forgot-password'}}}
      {{/if}}
      {{{settingsItem 'help-and-feedback'}}}
    {{/if}}
  </ul>
</template>

<template name="settingsItem">
  <li class="{{name}} trigger list-group-item">
    {{title}}
    {{#if isSetting}}
      <span class="ppicon-up-open"></span>
    {{else}}
      <span class="ppicon-down-open"></span>
    {{/if}}
  </li>
  {{#if isSetting}}
    <li class="{{name}} action list-group-item">
      {{{action}}}
    </li>
  {{/if}}
</template>

<template name="devSignIn">
  <form class="dev-sign-in" role="form">
    <div class="tight form-group">
      <input type="email" class="form-control email"
             placeholder="Your email" value="{{email}}" required autofocus>
      <input type="password" class="form-control password"
             placeholder="Your password" required>
    </div>
    {{{alerts 'devSignIn'}}}
    <button class="btn sign-in" type="submit">Sign in</button>
  </form>
</template>

<template name="devSignUp">
  <form class="dev-sign-up" role="form">
    <strong class="form-heading">Glad to have you!</strong>
    <p>Be sure to check for your email confirmation.</p>
    <div class="tight form-group">
      <input type="text" class="form-control full-name"
             placeholder="Your full name" required autofocus>
      <input type="email" class="form-control email"
             placeholder="Your email" value="{{email}}" required>
      <input type="password" class="form-control password"
             placeholder="Your password" required>
    </div>
    {{{alerts 'devSignUp'}}}
    <button class="btn sign-up" type="submit">Sign up</button>
  </form>
</template>

<template name="devSetPassword">
  <form class="dev-set-password" role="form">
    <p class="form-heading">Set your password:</p>
    <div class="form-group">
      <input type="password" class="form-control"
             placeholder="Your new password" required autofocus>
    </div>
    {{{alerts 'setPassword'}}}
    <button class="btn set-password" type="submit">Set password</button>
  </form>
</template>

<template name="devForgotPassword">
  <form class="dev-forgot-password" role="form">
    <p class="form-heading">Get a link to reset your password:</p>
    <div class="form-group">
      <input type="email" class="form-control"
             placeholder="Your email" required autofocus>
    </div>
    {{{alerts 'forgotPassword'}}}
    <button class="btn forgot-password" type="submit">Send reset link</button>
  </form>
</template>

<template name="devHelpAndFeedback">
  <form class="dev-help-and-feedback" role="form">
    <p class="form-heading">What kind of feedback are you sending?</p>
    <div class="form-group">
      <div class="radio">
        <label>
          <input type="radio" name="feedback" value="question" checked>
          Question
        </label>
      </div>
      <div class="radio">
        <label>
          <input type="radio" name="feedback" value="suggestion">
          Suggestion
        </label>
      </div>
      <div class="radio">
        <label>
          <input type="radio" name="feedback" value="bug-report">
          Bug report
        </label>
      </div>
      <div class="radio">
        <label>
          <input type="radio" name="feedback" value="love">
          Love
        </label>
      </div>
    </div>
    <div class="form-group">
      <textarea class="form-control" rows="3"></textarea>
    </div>
    <button class="btn help-and-feedback" type="submit">Send</button>
  </form>
</template>

<template name="devSubscriptions">
Subscriptions!
</template>

<template name="devChangeEmailAddress">
Change email address!
</template>

<template name="devChangePassword">
<form class="change-password" role="form">
  <div class="tight form-group">
    <!-- Session 'strange-passwd' only supplied during first session -->
    <input type="password" class="old-password form-control"
           value="{{SGet 'strange-passwd'}}"
           placeholder="Current password" required autofocus>
    <input type="password" class="new-password form-control"
           placeholder="New password" required>
  </div>
  {{{alerts 'changePassword'}}}
  <button class="btn change-password" type="submit">Change password</button>
</form>
</template>

<template name="tinySpinner">
  <i class="fa fa-refresh fa-spin"></i>
</template>
